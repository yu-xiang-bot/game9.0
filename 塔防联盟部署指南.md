# 塔防联盟 - 部署指南

## 概述

本指南详细介绍如何部署基于Vue3+Vite技术栈的"塔防联盟"游戏，涵盖环境准备、构建配置、部署实施和验证优化四个步骤，适用于本地测试、云服务器和静态托管平台三种场景。

---

## 第一步：环境准备

### 1.1 环境与依赖确认

#### 本地开发环境（用于构建）
- **Node.js** ≥ v16（推荐v18+，兼容Vite 3.x）
- **npm** ≥ 8 或 **yarn** ≥ 1.22
- **Git**（拉取代码）

#### 生产环境（根据部署方式选择）
- **静态托管**：Netlify/Vercel/GitHub Pages（无需服务器，直接托管静态文件）
- **云服务器**：阿里云ECS/腾讯云CVM（需Linux系统+Nginx/Apache）
- **CDN加速**：阿里云OSS/腾讯云COS（存储静态资源，配合域名访问）

### 1.2 代码与配置检查

#### 拉取代码
```bash
git clone https://github.com/你的用户名/塔防联盟.git
cd 塔防联盟
```

#### 确认关键配置
- **API地址**：文档提到"开发环境API代理至http://codeape.site:3030"，生产环境需修改前端API请求地址
- **资源路径**：检查vite.config.ts中base配置（默认'/'），若部署到子路径（如https://yourdomain.com/td-game/），需改为base: '/td-game/'

---

## 第二步：构建配置

### 2.1 安装依赖与类型检查

```bash
# 安装依赖（确保node_modules完整）
npm install

# 类型检查（避免TS错误导致构建失败）
npm run tsc
```

### 2.2 配置环境变量（关键！）

项目需区分开发/生产环境的API地址、资源路径等，通过.env文件配置。

#### 创建生产环境配置
在项目根目录创建 `.env.production`（生产环境专用）：

```env
# API基础地址（替换为你的后端服务地址，如已部署后端）
VITE_API_BASE_URL=https://your-backend-domain.com/api

# 静态资源CDN地址（可选，如用OSS/COS托管资源）
VITE_CDN_URL=https://your-cdn-domain.com/td-game/

# 游戏标题（可选，覆盖index.html的title）
VITE_GAME_TITLE=塔防联盟
```

#### 代码中读取环境变量
在service/目录下创建config.ts，统一配置请求地址：

```typescript
export const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://codeape.site:3030';
```

### 2.3 执行生产构建

```bash
# 构建生产版本（输出到dist目录）
npm run build
```

构建成功后，项目根目录会生成dist文件夹，包含：
- **index.html**（入口HTML）
- **assets/**（JS/CSS/图片/音频等静态资源，含Web Worker文件）
- **favicon.ico**等图标文件

---

## 第三步：部署实施

### 场景1：静态托管平台（推荐新手，零服务器配置）

适合纯前端项目，直接托管dist静态文件，平台自动处理HTTPS、CDN加速。

#### Vercel部署示例

1. **上传代码到GitHub**：确保项目已推送到你的GitHub仓库
2. **导入项目到Vercel**：
   - 登录 https://vercel.com/，点击「Add New Project」→ 选择你的GitHub仓库
3. **配置构建设置**：
   - **Framework Preset**：选择「Vite」
   - **Build Command**：npm run build
   - **Output Directory**：dist
   - **Environment Variables**：添加.env.production中的变量（如VITE_API_BASE_URL）

部署完成后，Vercel自动分配域名（如your-project.vercel.app），访问即可打开游戏。

### 场景2：云服务器部署（适合自定义域名+后端整合）

需购买云服务器（如阿里云ECS，选CentOS/Ubuntu系统），搭配Nginx作为Web服务器。

#### Step 1：服务器环境配置

```bash
# 登录服务器（SSH）
ssh root@你的服务器IP

# 安装Node.js（若需服务器端构建，也可本地构建后上传dist）
curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
yum install -y nodejs  # CentOS
# 或
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt-get install -y nodejs  # Ubuntu

# 安装Nginx
yum install -y nginx  # CentOS
# 或
apt install -y nginx  # Ubuntu
```

#### Step 2：上传构建产物

**本地构建后上传**：
```bash
# 在本地执行npm run build生成dist，通过scp上传到服务器
scp -r dist/* root@你的服务器IP:/var/www/td-game/
```

**服务器上构建**：
```bash
git clone https://github.com/你的用户名/塔防联盟.git
cd 塔防联盟
npm install
npm run build  # 构建产物在./dist
mv dist /var/www/td-game  # 移动到Nginx静态资源目录
```

#### Step 3：配置Nginx

编辑Nginx配置文件（如/etc/nginx/conf.d/td-game.conf）：

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 你的域名（需提前解析到服务器IP）

    # 静态资源根目录（指向dist文件夹）
    root /var/www/td-game;
    index index.html;

    # 处理Vue Router history模式（避免刷新404）
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 配置API反向代理（若前端需直接调用后端API，避免跨域）
    location /api/ {
        proxy_pass https://your-backend-domain.com/api/;  # 后端API地址
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 静态资源缓存（优化加载速度）
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2)$ {
        expires 30d;  # 缓存30天
        add_header Cache-Control "public, max-age=2592000";
    }
}
```

重启Nginx生效：
```bash
nginx -t  # 检查配置语法
systemctl restart nginx
```

#### Step 4：配置HTTPS（可选但推荐）

用Let's Encrypt申请免费SSL证书：

```bash
# 安装Certbot
yum install -y certbot python3-certbot-nginx  # CentOS
# 或
apt install -y certbot python3-certbot-nginx  # Ubuntu

# 自动配置HTTPS（按提示输入域名）
certbot --nginx -d your-domain.com
```

### 场景3：CDN加速部署（适合高并发场景）

将dist静态资源上传到CDN（如阿里云OSS），通过CDN域名访问，提升全球加载速度。

#### 上传资源到CDN
- **阿里云OSS**：创建Bucket→开启"静态网站托管"→上传dist内所有文件→获取访问域名（如https://your-bucket.oss-cn-beijing.aliyuncs.com）

#### 配置CDN加速
- 在CDN控制台添加域名（如game.yourdomain.com），源站指向OSS域名，开启HTTPS、Gzip压缩

#### 前端适配CDN路径
在vite.config.ts中设置base: 'https://game.yourdomain.com/'，重新构建后将资源上传CDN。

---

## 第四步：验证优化

### 4.1 基础功能验证

#### 访问测试
打开部署后的域名（如https://your-domain.com），检查：
- 游戏是否正常加载（无白屏、资源404）
- 关卡选择、防御塔建造、敌人移动等核心功能是否可用
- 移动端触摸操作、PC端键盘快捷键是否响应

#### API连通性
登录/注册、进度保存、排行榜等功能需调用后端API，检查Network面板是否有API请求错误（如403/500）

### 4.2 性能优化（可选）

#### 资源压缩
确保Nginx开启Gzip/Brotli压缩（在Nginx配置中添加gzip on）

#### 缓存策略
通过Nginx配置静态资源长期缓存（如上文expires 30d），HTML文件不缓存（add_header Cache-Control "no-cache"）

#### Web Worker验证
打开浏览器DevTools→Sources→Workers，确认游戏Worker（gameWorker/workers/*.js）正常加载并执行

### 4.3 后续维护

#### 更新部署
代码修改后，本地执行npm run build生成新dist，上传覆盖服务器/CDN资源

```bash
# 备份
cp -r /path/to/塔防联盟/dist /path/to/backups/塔防联盟-$(date +%Y%m%d)

# 更新
git pull origin main
npm ci
npm run build
cp -r dist/* /path/to/塔防联盟/dist/

# 重启Nginx
sudo systemctl reload nginx
```

#### 监控告警
- 接入Sentry监控JS错误
- 用Prometheus+Grafana监控服务器性能
- 定期备份服务器/var/www/td-game目录和CDN资源

---

## 关键注意事项

### 1. Web Worker路径问题
Vite构建时会自动处理Worker文件（生成worker-xxx.js），部署时需确保dist目录结构完整，避免Worker加载失败。可通过DevTools→Network筛选"worker"查看。

### 2. 跨域问题
若前端直接调用后端API（非开发环境代理），需后端配置CORS（如Nginx添加add_header Access-Control-Allow-Origin *;），或通过Nginx反向代理统一转发API请求（见场景2的Nginx配置）。

### 3. 移动端适配
部署后需用真机测试不同屏幕尺寸（iPhone/Android），确保Canvas渲染无错位、触摸操作流畅。

---

## 总结

通过以上步骤，即可将"塔防联盟"游戏部署到线上环境，供用户访问体验。若涉及后端API部署（如用户系统、排行榜），需同步部署后端服务（文档未提及后端技术栈，假设为Node.js/Java等，按对应技术部署即可）。

## 联系方式

如有部署相关问题，请联系：
- **作者**：yx
- **邮箱**：1829738634@qq.com
- **项目仓库**：https://github.com/ApeWhoLovesCode/LegendTD