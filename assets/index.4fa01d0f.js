var je=Object.defineProperty;var qe=(t,o,e)=>o in t?je(t,o,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[o]=e;var ne=(t,o,e)=>(qe(t,typeof o!="symbol"?o+"":o,e),e);import{d as M,b as C,A as we,o as y,e as b,f as n,v as k,l as F,i as Ke,g as D,w as A,k as a,Q as O,n as L,p as ee,j as te,a4 as re,S as ge,s as le,F as ce,a as Se,z as x,X as V,a3 as X,q as ye,t as $,r as z,m as me,B as be,P as We,O as Ue,a5 as ke,a6 as ve,E as P,u as Ve,a7 as Xe}from"./index.bc555423.js";import{L as Je,W as Ye,u as Qe,c as Ze}from"./myGame.6e9a1829.js";import{u as R,o as ue,r as Ee}from"./source.4b31753f.js";import{_ as G}from"./_plugin-vue_export-helper.cdc0426e.js";import{r as et}from"./format.4b9e5d75.js";import{l as Y,L as Q,_ as tt}from"./userBall.vue_vue_type_style_index_0_lang.1b4339fe.js";const H=t=>(ee("data-v-7c4077c3"),t=t(),te(),t),ot={class:"com-game-navbar"},st={class:"left"},at={class:"left-area"},nt=H(()=>n("span",{class:"icon-wrap"},[n("span",{class:"iconfont icon-jinbi1"})],-1)),it={class:"money"},ut={key:0,class:"add-money"},rt={class:"center"},lt={class:"level fff-color"},ct=H(()=>n("span",{class:"fff-color",style:{margin:"0 4px"}},"/",-1)),mt=H(()=>n("span",{class:"level2 fff-color"},"\u221E",-1)),dt={class:"right"},pt=H(()=>n("div",{class:"icon-arrow-box"},null,-1)),ft=[pt],ht=H(()=>n("span",{class:"iconfont icon-jurassic_restart"},null,-1)),_t=[ht],gt=H(()=>n("span",{class:"icon-wrap icon-hover"},[n("span",{class:"iconfont icon-xuanxiangka_fuzhi"})],-1)),vt=M({__name:"gameNavBar",props:{money:{type:Number,default:0},level:{type:Number,default:0},isPause:{type:Boolean,default:!0},isPlayBgAudio:{type:Boolean,default:!0}},emits:["gamePause","playBgAudio","reStart","exitGame"],setup(t,{emit:o}){const e=t,r=R(),h=C({num:"",timer:void 0,time:1e3});we(()=>e.money,(c,m)=>{h.num="",clearTimeout(h.timer),h.timer=void 0,re(()=>{const _=c-m;h.num=(_>=0?"+":"")+_,h.timer=setTimeout(()=>{h.num=""},h.time)})});const i=()=>{ge.confirm("\u5F53\u524D\u7684\u6210\u7EE9\u5C06\u4F5C\u4E3A\u6700\u7EC8\u7684\u6210\u7EE9\uFF0C\u60A8\u786E\u5B9A\u8981\u4E0A\u4F20\u5F97\u5206\u5E76\u91CD\u65B0\u5F00\u59CB\u6E38\u620F\u5417\uFF1F",{confirmButtonText:"\u786E\u5B9A",cancelButtonText:"\u53D6\u6D88",type:"warning"}).then(()=>{o("reStart")})},l=()=>{ge.confirm("\u60A8\u786E\u5B9A\u8981\u9000\u51FA\u6E38\u620F\u5417\uFF1F\u5F53\u524D\u9875\u9762\u6E38\u620F\u6570\u636E\u5C06\u6E05\u9664\u3002",{confirmButtonText:"\u786E\u5B9A",cancelButtonText:"\u53D6\u6D88",type:"warning"}).then(()=>{o("exitGame")})};return(c,m)=>(y(),b("div",ot,[n("div",st,[n("div",at,[nt,n("span",it,k(t.money),1),h.num?(y(),b("span",ut,k(h.num),1)):F("",!0)])]),n("div",rt,[n("span",lt,k(t.level+1),1),ct,mt,Ke(" \u6CE2\u50F5\u5C38 ")]),n("div",dt,[D(a(O),{effect:"dark",content:"\u5F00\u59CB / \u6682\u505C\u6E38\u620F",placement:a(r).isMobile?"left":"bottom"},{default:A(()=>[n("span",{class:"icon-wrap icon-hover",onClick:m[0]||(m[0]=_=>o("gamePause"))},[n("span",{class:L(["iconfont",t.isPause?"icon-kaishi1":"icon-24gf-pause2"])},null,2)])]),_:1},8,["placement"]),D(a(O),{effect:"dark",content:"\u9000\u51FA\u6E38\u620F",placement:a(r).isMobile?"left":"bottom"},{default:A(()=>[n("span",{class:"icon-wrap icon-hover exit-button",onClick:l},ft)]),_:1},8,["placement"]),D(a(O),{effect:"dark",content:"\u64AD\u653E / \u5173\u95ED\u97F3\u4E50",placement:a(r).isMobile?"left":"bottom"},{default:A(()=>[n("span",{class:"icon-wrap icon-hover",onClick:m[1]||(m[1]=_=>o("playBgAudio"))},[n("span",{class:L(["iconfont",t.isPlayBgAudio?"icon-mn_shengyin_fill":"icon-mn_shengyinwu_fill"])},null,2)])]),_:1},8,["placement"]),D(a(O),{effect:"dark",content:"\u4E0A\u4F20\u6210\u7EE9\uFF0C\u91CD\u65B0\u5F00\u59CB",placement:a(r).isMobile?"left":"bottom"},{default:A(()=>[n("span",{class:"icon-wrap icon-hover",onClick:i},_t)]),_:1},8,["placement"]),D(a(O),{effect:"dark",content:"\u5176\u4ED6\u5DE5\u5177\uFF08\u5F85\u5F00\u53D1\uFF09",placement:a(r).isMobile?"left":"bottom"},{default:A(()=>[gt]),_:1},8,["placement"])])]))}});const wt=G(vt,[["__scopeId","data-v-7c4077c3"]]),St=t=>(ee("data-v-b2310651"),t=t(),te(),t),yt={key:0,class:"game-begin mask"},bt={class:"info"},kt={key:1,class:"begin-wrap"},Et=St(()=>n("span",{class:"begin-text"},"\u5F00\u59CB\u6E38\u620F",-1)),Dt={key:1,class:"gameover-wrap mask"},Bt={class:"info"},Ft=M({__name:"startAndEnd",props:{gameConfigState:{},baseDataState:{}},emits:["beginGame","reStart","reUploadScore"],setup(t,{emit:o}){return(e,r)=>(y(),b(ce,null,[e.gameConfigState.isGameBeginMask?(y(),b("div",yt,[n("div",bt,[e.gameConfigState.loadingDone?(y(),b("div",kt,[n("span",{class:"icon-wrap",onClick:r[0]||(r[0]=h=>o("beginGame"))},[n("span",{class:L(["iconfont",e.baseDataState.isPause?"icon-kaishi1":"icon-24gf-pause2"])},null,2)]),Et])):(y(),le(Je,{key:0}))])])):F("",!0),e.baseDataState.isGameOver?(y(),b("div",Dt,[n("div",Bt,"\u4F60\u6210\u529F\u62B5\u5FA1\u4E86"+k(e.baseDataState.level)+"\u6CE2\u50F5\u5C38",1),n("div",{class:"restart-btn",onClick:r[1]||(r[1]=h=>o("reStart"))},"\u91CD\u65B0\u5F00\u59CB")])):F("",!0)],64))}});const Ct=G(Ft,[["__scopeId","data-v-b2310651"]]),Tt=t=>(ee("data-v-5b424615"),t=t(),te(),t),At=["src"],$t=["onClick"],Mt=["src"],zt={class:"tower-info"},Pt=Tt(()=>n("span",{class:"iconfont icon-ashbin"},null,-1)),xt={class:"sale-num"},It=M({__name:"towerBuild",props:{towerState:{},baseDataState:{},size:{}},emits:["buildTower","saleTower"],setup(t,{emit:o}){const e=t,r=R(),h=Se(),i=x(()=>{const{left:d,top:w}=e.towerState.building,s=_(e.size);return{left:_(d)+s+"px",top:_(w)+s+"px"}}),l=x(()=>{const{left:d,top:w}=e.towerState.building,{x_num:s,y_num:S}=e.baseDataState.gridInfo,p=e.size,E=Math.round(d/p),j=Math.round(w/p);let T="";return j>=S-5&&(T+="tower-wrap-bottom "),(E<=1||E>=s-2)&&(T+="tower-wrap-row ",j>=2&&(T+="tower-wrap-row-top "),E<=1?T+="tower-wrap-left":T+="tower-wrap-right"),T}),c=x(()=>{const d=_(e.size),{left:w,top:s,r:S}=e.towerState.buildingScope;return{left:_(w)+d+d/2+"px",top:_(s)+d+d/2+"px",width:_(S)*2+"px",height:_(S)*2+"px"}}),m=x(()=>{const{y_num:d}=e.baseDataState.gridInfo,w=e.size;return Math.round(e.towerState.buildingScope.top/w)>=d/2?{top:0}:{bottom:0}});function _(d){return d/r.ratio}return(d,w)=>{var s;return y(),b("div",{class:"towerBuild",style:$({"--buildSize":(a(r).isMobile?e.size/a(r).ratio*1.5:e.size/a(r).ratio)+"px"})},[V(n("div",{class:"building-wrap",style:$(i.value)},[n("img",{src:a(ue).building,alt:"",class:"add-icon"},null,8,At),a(r).towerSource?(y(),b("div",{key:0,class:L(["tower-wrap",l.value])},[(y(!0),b(ce,null,ye(a(h).towerSelectList,(S,p)=>(y(),b("div",{class:L(["tower",{"tower-no-money":d.baseDataState.money<a(r).towerSource[S].money,"tower-mobile":a(r).isMobile}]),key:p,onClick:E=>o("buildTower",S)},[n("img",{src:a(r).towerSource[S].cover||a(r).towerSource[S].img,alt:"",class:"tower-icon"},null,8,Mt),n("div",zt,"\uFFE5"+k(a(r).towerSource[S].money),1)],10,$t))),128))],2)):F("",!0)],4),[[X,d.towerState.building.isShow]]),V(n("div",{class:"building-scope",style:$(c.value)},[n("span",{class:"sale-wrap",onClick:w[0]||(w[0]=S=>o("saleTower",d.towerState.buildingScope.towerId)),style:$(m.value)},[Pt,n("span",xt,k((s=d.towerState.buildingScope)==null?void 0:s.saleMoney),1)],4)],4),[[X,d.towerState.buildingScope.isShow]])],4)}}});const Lt=G(It,[["__scopeId","data-v-5b424615"]]),Rt={class:"com-skill"},Gt={class:"skill-wrap"},Nt={class:"com-skill-tooltip"},Ot={class:"skill-name"},Ht={class:"skill-item"},jt=["onClick"],qt={class:"skill-disable iconfont icon-disablecase"},Kt={key:0,class:"skill-boom"},Wt=["src"],Ut=M({__name:"skill",props:{skillList:{},money:{},isPause:{}},emits:["handleSkill"],setup(t,{emit:o}){const e=t,r=R(),h=i=>e.money<i||e.isPause;return(i,l)=>(y(),b("div",Rt,[n("div",Gt,[(y(!0),b(ce,null,ye(i.skillList,(c,m)=>(y(),b("span",{key:m},[D(a(O),{effect:"dark",placement:a(r).isMobile?"right":"top"},{content:A(()=>[n("div",Nt,[n("div",Ot,k(c.name),1),n("div",null,k(c.instructions),1),n("div",null,"\u91D1\u989D\uFF1A"+k(c.money)+" cd\uFF1A"+k(c.cd/1e3)+"\u79D2",1)])]),default:A(()=>[n("span",Ht,[n("span",{class:L(["skill iconfont",c.icon]),onClick:_=>!h(c.money)&&o("handleSkill",m)},null,10,jt),V(n("span",qt,null,512),[[X,h(c.money)]]),V(n("span",{class:"skill-disable skill-time"},k(c.curTime/1e3),513),[[X,c.curTime]])])]),_:2},1032,["placement"])]))),128))]),i.skillList[0].isShow?(y(),b("div",Kt)):F("",!0),i.skillList[1].isShow?(y(),b("img",{key:1,class:"skill-rush",src:a(Ee)("meat-rush.png"),alt:""},null,8,Wt)):F("",!0)]))}});const Vt=G(Ut,[["__scopeId","data-v-1ec9b121"]]),Xt=["src"],Jt=["src"],Yt=M({__name:"terminal",props:{baseDataState:{},gameConfigState:{},gameSkillState:{}},emits:["proMoneyClick"],setup(t,{emit:o}){const e=t,r=R(),h=x(()=>{const l=i(e.gameConfigState.size);if(e.baseDataState.terminal){const{x:c,y:m}=e.baseDataState.terminal;return{left:i(c)+l/2+"px",top:i(m)-l/2+"px"}}});function i(l){return l/r.ratio}return(l,c)=>l.baseDataState.terminal?(y(),b("div",{key:0,class:"terminal",style:$(h.value)},[n("div",{class:L(["hp",{"hp-mobile":a(r).isMobile}])},k(l.baseDataState.hp),3),n("img",{class:"terminal-icon",src:a(ue).terminal,alt:""},null,8,Xt),V(n("img",{class:"money-icon",src:a(ue).sunGif,alt:"",onClick:c[0]||(c[0]=m=>o("proMoneyClick"))},null,8,Jt),[[X,l.gameSkillState.proMoney.isShow]])],4)):F("",!0)}});const Qt=G(Yt,[["__scopeId","data-v-249a356a"]]),Zt=t=>(ee("data-v-a5245245"),t=t(),te(),t),eo={class:"com-progress-bar"},to={class:"progress-wrap"},oo=Zt(()=>n("div",{class:"progress-title"},"\u6B63\u5728\u52AA\u529B\u52A0\u8F7D\u4E2D~",-1)),so=["width","height"],ao={class:"progress-text"},no=M({__name:"progressBar",props:{progress:{type:Number,default:0}},emits:["loadDone"],setup(t,{emit:o}){const e=t,r=R(),h=z(),i=C({ctx:null,canvasInfo:{w:0,h:0},curProgress:0,animationFrame:0}),l=x(()=>{const{h:d}=i.canvasInfo;return{background:"#fff",borderRadius:`${d/2}px`,width:i.canvasInfo.w/r.ratio+"px",height:i.canvasInfo.h/r.ratio+"px"}});we(()=>e.progress,(d,w)=>{i.curProgress=w,m(d)}),me(()=>{c()}),be(()=>{cancelAnimationFrame(i.animationFrame)});const c=()=>{i.ctx=h.value.getContext("2d");const d=document.querySelector(".com-progress-bar");i.canvasInfo.w=Math.round(d.clientWidth*.8*r.ratio),i.canvasInfo.h=Math.round(d.clientHeight*(r.isMobile?.08:.06)*r.ratio)},m=d=>{(function w(){_(++i.curProgress),i.curProgress<d?i.animationFrame=requestAnimationFrame(w):i.curProgress>=100&&(setTimeout(()=>{o("loadDone")},300),cancelAnimationFrame(i.animationFrame))})()},_=d=>{var E;const{w,h:s}=i.canvasInfo;(E=i.ctx)==null||E.clearRect(0,0,w,s);const S=w*d/100,p=i.ctx.createLinearGradient(0,0,S,s);p.addColorStop(0,"#00f2fe"),p.addColorStop(1,"#4facfe"),i.ctx.fillStyle=p,i.ctx.fillRect(0,0,S,s)};return(d,w)=>(y(),b("div",eo,[n("div",to,[oo,n("canvas",{ref_key:"progressCanvasRef",ref:h,id:"canvas-progress",width:i.canvasInfo.w,height:i.canvasInfo.h,style:$(l.value)},null,12,so),n("div",ao,k(a(et)(Math.round(i.curProgress),0,100))+" / 100%",1)])]))}});const io=G(no,[["__scopeId","data-v-a5245245"]]);function uo(){const t=z(),o=z(),e=z(),r=z(),h=z();return{canvasRef:t,audioBgRef:o,audioLevelRef:e,audioSkillRef:r,audioEndRef:h,audioRefObj:{audioBgRef:o,audioLevelRef:e,audioSkillRef:r,audioEndRef:h}}}function ro(){return{gameConfigState:C({defaultCanvas:{w:1e3,h:600},size:50,canvas:{},animationFrame:0,ctx:null,loadingDone:!1,isGameBeginMask:!0,gameStartTime:void 0})}}function lo(){const t=C({terminal:void 0,gridInfo:{x_num:20,y_num:12,size:50},isGameOver:!1,isPause:!0,isPlayBgAudio:!1,level:0,hp:10,money:5e3});function o(){t.isGameOver||(t.isPause=!t.isPause)}return{baseDataState:t,gamePause:o}}const v=t=>Ee(t,"audio"),I={"pvz-morning":v("pvz-morning.mp3"),"pvz-comein":v("pvz-comein.mp3"),"pvz-dance":v("pvz-dance.mp3"),"pvz-sound":v("pvz-sound.mp3"),"pvz-little":v("pvz-little.mp3"),"ma-pvz":v("ma-pvz.mp3"),"ma-nansou":v("ma-nansou.mp3"),"ma-zhata":v("ma-zhata.mp3"),"ma-roudan":v("ma-roudan.mp3"),"ma-gameover":v("ma-gameover.mp3"),"ma-haha":v("ma-haha.mp3"),kunkun:v("kunkun.mp3"),"aixi-choose":v("aixi-choose.mp3"),"pdd-choose":v("pdd-heihaha.mp3"),"lanbo-choose":v("lanbo-choose.mp3"),"jin-choose":v("jin-choose.mp3"),"ejiate-choose":v("ejiate-choose.mp3"),"nanqiang-choose":v("nanqiang-choose.mp3"),"ez-choose":v("ez-choose.mp3"),"delaiwen-choose":v("delaiwen-choose.mp3"),"huonan-choose":v("huonan-choose.mp3"),"twitch-choose":v("twitch-choose.mp3"),"create-money":v("coin-2s.mp3"),"skill-coin":v("coin-4s.mp3"),"game-fail":v("game-fail.mp3"),"skill-boom":v("skill-boom.mp3"),"godzilla-fire":v("godzilla-fire-short.mp3"),"zombie-boom-countdown":v("zombie-boom-countdown.mp3"),"zombie-boom-scream":v("zombie-boom-scream.mp3"),"zombie-boom-boom":v("zombie-boom-boom.mp3"),"ice-car-frozen":v("ice-car-frozen.mp3")};function co(){const t=C({audioEnd:"",audioSkill:""});function o(h,i){const l=document.querySelector("#audio-wrap"),c=document.createElement("audio");c.id=i,I[h]&&(c.src=I[h]),l==null||l.appendChild(c)}function e({id:h,audioKey:i,volume:l=.4}){const c=document.querySelector("#audio-wrap"),m=c==null?void 0:c.querySelector(`#${h}`);!m||(i&&(m.src=I[i]),m.volume=l,m.play())}function r(h){const i=document.querySelector(`#${h}`);i&&i.remove()}return{audioState:t,createAudio:o,playDomAudio:e,removeAudio:r}}const mo=[{name:"\u70B8\u4ED6\u4E00\u6CE2",instructions:"\u5BF9\u573A\u4E0A\u6240\u6709\u654C\u4EBA\u9020\u6210100\u70B9\u4F24\u5BB3",icon:"icon-remen1",money:300,damage:100,cd:3e4,curTime:0,audioKey:"ma-zhata",isShow:!1,showTime:2e3},{name:"\u8089\u5F39\u51B2\u51FB",instructions:"\u7729\u6655\u573A\u4E0A\u6240\u6709\u654C\u4EBA6\u79D2\uFF0C\u5E76\u9020\u62101\u70B9\u4F24\u5BB3",icon:"icon-jianshen-daduzi-pijiudu",money:500,damage:1,cd:6e4,curTime:0,audioKey:"ma-roudan",isShow:!1,showTime:2e3},{name:"\u793C\u7269",instructions:"\u968F\u673A\u83B7\u5F971-100\u91D1\u5E01",icon:"icon-gift",money:0,damage:0,cd:3e4,curTime:0,audioKey:"skill-coin",isShow:!1,showTime:2e3}];function po(){return{gameSkillState:C({proMoney:{isShow:!1,interval:1e4,money:25},addMoney:{num:"",timer:void 0,time:1e3},skillList:JSON.parse(JSON.stringify(mo))})}}function fo(){const t=C({building:{left:0,top:0,isShow:!1},buildingScope:{left:0,top:0,r:0,isShow:!1,towerId:"",saleMoney:0}});function o(r){t.building.isShow=!0,t.building.left=r.left,t.building.top=r.top}function e(){t.building.isShow&&(t.building.isShow=!1),t.buildingScope.isShow&&(t.buildingScope.isShow=!1)}return{towerState:t,showTowerBuilding:o,hiddenTowerOperation:e}}function ho(){const t=C(new Map);function o(c,m,_=0,{isTimeOut:d=!1,isCover:w}={}){l(c),(!t.has(c)||w)&&m&&t.set(c,{timeout:void 0,interval:void 0,cur:0,end:0,fn:m,intervalTime:_,remainTime:_,isTimeOut:d});const s=t.get(c);_&&s.intervalTime!==_&&(s.intervalTime=_,s.remainTime=_),s.remainTime-=s.end-s.cur,s.cur=Date.now(),s.end=s.cur,s.timeout=setTimeout(()=>{s.cur=Date.now(),s.end=s.cur,s.remainTime=s.intervalTime,s.isTimeOut||(s.interval=setInterval(()=>{s.cur=Date.now(),s.end=s.cur,s.fn()},s.intervalTime)),s.fn(),s.isTimeOut&&h(c)},s.remainTime)}function e(c){const m=t.get(c);if(m)return m.end=Date.now(),l(c),m.end-m.cur}function r(c=!0){t.forEach((m,_)=>{c?e(_):o(_)})}function h(c){l(c),t.has(c)&&t.delete(c)}function i(){t&&(t.forEach((c,m)=>{l(m)}),t.clear())}function l(c){const m=t.get(c);m!=null&&m.timeout&&(clearTimeout(m.timeout),m.timeout=void 0),m!=null&&m.interval&&(clearInterval(m.interval),m.interval=void 0)}return We(()=>{i()}),{set:o,pause:e,allPause:r,delete:h,clear:i,stopTime:l}}const ie={makeEnemy:"makeEnemy",startMoneyTimer:"startMoneyTimer",slow:"slow",skill:"skill",towerShoot:"towerShoot",twitch:"twitch",twitchDelete:"twitchDelete",poisonFun:"poisonFun",frozenTower:"frozenTower"},de=class{constructor(){ne(this,"timerMap",new Map)}static get instance(){return this._instance||(this._instance=new de),this._instance}set(o,e,r=0,{isTimeOut:h=!1,isCover:i}={}){this.stopTime(o),(!this.timerMap.has(o)||i)&&e&&this.timerMap.set(o,{timeout:void 0,interval:void 0,cur:0,end:0,fn:e,intervalTime:r,remainTime:r,isTimeOut:h});const l=this.timerMap.get(o);r&&l.intervalTime!==r&&(l.intervalTime=r,l.remainTime=r),l.remainTime-=l.end-l.cur,l.cur=Date.now(),l.end=l.cur,l.timeout=setTimeout(()=>{l.cur=Date.now(),l.end=l.cur,l.remainTime=l.intervalTime,l.isTimeOut||(l.interval=setInterval(()=>{l.cur=Date.now(),l.end=l.cur,l.fn()},l.intervalTime)),l.fn(),l.isTimeOut&&this.delete(o)},l.remainTime)}pause(o){const e=this.timerMap.get(o);if(e)return e.end=Date.now(),this.stopTime(o),e.end-e.cur}allPause(o=!0){this.timerMap.forEach((e,r)=>{o?this.pause(r):this.set(r)})}delete(o){this.stopTime(o),this.timerMap.has(o)&&this.timerMap.delete(o)}clear(){this.timerMap&&(this.timerMap.forEach((o,e)=>{this.stopTime(e)}),this.timerMap.clear())}stopTime(o){const e=this.timerMap.get(o);e!=null&&e.timeout&&(clearTimeout(e.timeout),e.timeout=void 0),e!=null&&e.interval&&(clearInterval(e.interval),e.interval=void 0)}};let Z=de;ne(Z,"_instance");Z.instance;const _o={id:"protect-horse"},go=["width","height"],vo={id:"audio-wrap"},wo=["src"],So=["src"],yo=["src"],bo=["src"],ko=M({__name:"game",emits:["reStart","exitGame"],setup(t,{emit:o}){const e=R(),r=Se(),h=Ue(),i=ho(),{canvasRef:l,audioBgRef:c,audioLevelRef:m,audioSkillRef:_,audioEndRef:d,audioRefObj:w}=uo(),{gameConfigState:s}=ro(),{gameSkillState:S}=po(),{baseDataState:p}=lo(),{audioState:E,createAudio:j,playDomAudio:T,removeAudio:De}=co(),{towerState:oe,showTowerBuilding:Be,hiddenTowerOperation:pe}=fo(),Fe=ke(),J=z(),q=C({isProgressBar:!1,progress:0});me(()=>{Ce()}),be(()=>{ae()});function Ce(){Ne(),q.isProgressBar=!0,setTimeout(()=>{Te(),He()},10)}function Te(){const f=document.getElementById("game-canvas").transferControlToOffscreen(),g=new Ye;J.value=g,g.postMessage({init:!0,source:{isMobile:e.isMobile,ratio:e.ratio,mapLevel:e.mapLevel},setting:{isHighRefreshScreen:h.isHighRefreshScreen},canvasInfo:{offscreen:f,size:s.size},isDevTestMode:Fe.query.dev==="test"},[f]),g.onmessage=U=>{const{data:N}=U,B=N.param;switch(N.fnName){case"unifiedMoney":{p.money=B;break}case"createAudio":{j(B.audioKey,B.id);break}case"handlerTower":{oe.buildingScope=B;break}case"showTowerBuilding":{Be(B);break}case"buildTowerCallback":{Ie(B);break}case"removeAudio":{De(B);break}case"onLevelChange":{Ae(B);break}case"onHpChange":{ze(B);break}case"onWorkerReady":{$e(B);break}case"onProgress":{q.progress=B;break}case"playDomAudio":{T(B);break}}}}function Ae(u){var f;u&&(p.level=u,u/10%1===0&&K("ma-pvz","End"),(f=m.value)==null||f.play())}function $e(u){p.terminal={x:u.x*s.size,y:u.y*s.size},s.loadingDone=!0}function se(u){var g;p.isPause=u!=null?u:!p.isPause;const f=p.isPause;i.allPause(f),f||_e(),(g=J.value)==null||g.postMessage({isPause:f})}function Me(u){u.stopPropagation(),W("getMouse",{offsetX:u.offsetX,offsetY:u.offsetY})}function ze(u){p.hp=u,K("ma-nansou","End"),!u&&fe()}function ae(){var u,f;p.isGameOver=!0,p.isPause=!0,(u=c.value)==null||u.pause(),e.isGameing=!1,(f=J.value)==null||f.terminate(),i.clear()}async function fe(){if(K("game-fail","End"),ae(),Y[e.mapLevel].type!==Q.Normal)return;const{userInfo:u}=r;if(u){if(!p.level)return await ve(200),P.info("\u5F88\u9057\u61BE\u4F60\u4E00\u6CE2\u654C\u4EBA\u90FD\u6CA1\u62B5\u5FA1\u6210\u529F");try{await r.recordGameResult({levelId:e.mapLevel.toString(),score:p.level*100,starsEarned:p.level>10?3:p.level>5?2:1,isVictory:p.hp>0,completionTime:Date.now()-(s.gameStartTime||Date.now()),wavesCompleted:p.level,enemiesKilled:p.enemiesKilled||0,towersBuilt:p.towersBuilt||0,coinsSpent:p.coinsSpent||0,coinsEarned:p.coinsEarned||0,damageDealt:p.damageDealt||0,damageTaken:p.damageTaken||0,maxCombo:p.maxCombo||0,towersUsed:r.towerSelectList});const f=await Qe({userId:u.id,score:p.level*100,level:e.mapLevel}),g=f.data||f;P.success(g.isUpdate?"\u606D\u559C\uFF0C\u521B\u9020\u4E86\u5F53\u524D\u5730\u56FE\u7684\u65B0\u7EAA\u5F55~~":"\u8FD8\u672A\u8D85\u8D8A\u6700\u9AD8\u5206\uFF0C\u7EE7\u7EED\u52AA\u529B\u5427~~")}catch(f){console.error("\u4FDD\u5B58\u6E38\u620F\u7ED3\u679C\u5931\u8D25:",f),P.error("\u4FDD\u5B58\u6E38\u620F\u7ED3\u679C\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5")}}else await ve(200),P.info("\u767B\u5F55\u540E\u624D\u80FD\u4E0A\u4F20\u6210\u7EE9~~")}const Pe=()=>{ae(),o("exitGame")};function xe(u){if(p.money<e.towerSource[u].money)return;let{left:f,top:g}=oe.building;W("buildTower",{x:f,y:g,tname:u})}function Ie(u){j(`${u.audioKey}-choose`,u.towerId)}function Le(u){W("saleTower",u)}function Re(u){const{name:f,audioKey:g,showTime:U,cd:N}=S.skillList[u];K(g,"Skill"),S.skillList[u].isShow=!0,setTimeout(()=>{S.skillList[u].isShow=!1},U),S.skillList[u].curTime=N,i.set(`${ie.skill}-${f}`,()=>{S.skillList[u].curTime-=1e3,S.skillList[u].curTime<=0&&i.delete(`${ie.skill}-${f}`)},1e3),W("handleSkill",u)}function Ge(){var u;(u=m.value)==null||u.play(),he(),s.isGameBeginMask=!1,s.gameStartTime=Date.now(),W("resetGameStats",{}),se(!1),P({type:"success",message:"\u70B9\u51FB\u53F3\u4E0A\u65B9\u6309\u94AE\u6216\u6309\u7A7A\u683C\u952E\u7EE7\u7EED / \u6682\u505C\u6E38\u620F",duration:2500,showClose:!0}),e.isGameing=!0}function he(){var u,f;p.isPlayBgAudio=!p.isPlayBgAudio,p.isPlayBgAudio?(c.value.volume=.4,(u=c.value)==null||u.play()):(f=c.value)==null||f.pause()}function K(u,f){const g=`audio${f}`;E[g]!==void 0&&(E[g]!==u&&(E[g]=u),re(()=>{w[g+"Ref"].value.volume=.5,w[g+"Ref"].value.play()}))}function Ne(){let u=e.ratio;const{w:f,h:g}=s.defaultCanvas;if(e.isMobile){const U=document.documentElement.clientWidth/(g+150),N=document.documentElement.clientHeight/(f+100);u*=Math.floor(Math.min(U,N)*100)/100}s.size=Math.floor(s.size*u),s.defaultCanvas.w=Math.floor(f*u),s.defaultCanvas.h=Math.floor(g*u)}function _e(){i.set(ie.startMoneyTimer,()=>{S.proMoney.isShow=!0,K("create-money","End")},S.proMoney.interval,{isTimeOut:!0})}function Oe(){S.proMoney.isShow=!1,p.money+=S.proMoney.money,_e()}function He(){document.onkeydown=u=>{if(!s.isGameBeginMask)switch(u.code){case"Space":{se();break}}}}function W(u,f){var g;(g=J.value)==null||g.postMessage({fnName:u,event:f})}return(u,f)=>(y(),b("div",_o,[n("div",{class:"game-wrap",style:$({"--size":a(s).size/a(e).ratio+"px"})},[n("div",{class:"canvas-wrap",onClick:f[4]||(f[4]=(...g)=>a(pe)&&a(pe)(...g))},[D(wt,{money:a(p).money,level:a(p).level,isPause:a(p).isPause,isPlayBgAudio:a(p).isPlayBgAudio,onGamePause:se,onPlayBgAudio:he,onReStart:f[0]||(f[0]=g=>fe().then(()=>{o("reStart")})),onExitGame:Pe},null,8,["money","level","isPause","isPlayBgAudio"]),n("canvas",{id:"game-canvas",ref_key:"canvasRef",ref:l,width:a(s).defaultCanvas.w,height:a(s).defaultCanvas.h,style:$({width:a(s).defaultCanvas.w/a(e).ratio+"px",height:a(s).defaultCanvas.h/a(e).ratio+"px"}),onClick:f[1]||(f[1]=g=>Me(g))},null,12,go),D(Lt,{"tower-state":a(oe),"base-data-state":a(p),size:a(s).size,onBuildTower:xe,onSaleTower:Le},null,8,["tower-state","base-data-state","size"]),D(Vt,{skillList:a(S).skillList,money:a(p).money,isPause:a(p).isPause,onHandleSkill:Re},null,8,["skillList","money","isPause"]),D(Qt,{"game-config-state":a(s),"game-skill-state":a(S),"base-data-state":a(p),onProMoneyClick:Oe},null,8,["game-config-state","game-skill-state","base-data-state"]),D(Ct,{"base-data-state":a(p),"game-config-state":a(s),onBeginGame:Ge,onReStart:f[2]||(f[2]=g=>o("reStart"))},null,8,["base-data-state","game-config-state"]),q.isProgressBar?(y(),le(io,{key:0,progress:Math.ceil(q.progress),onLoadDone:f[3]||(f[3]=g=>q.isProgressBar=!1)},null,8,["progress"])):F("",!0)])],4),n("div",vo,[n("audio",{ref_key:"audioBgRef",ref:c,src:a(I)["pvz-morning"],loop:""},null,8,wo),n("audio",{ref_key:"audioLevelRef",ref:m,src:a(I)["pvz-comein"]},null,8,So),n("audio",{ref_key:"audioSkillRef",ref:_,src:a(I)[a(E).audioSkill]},null,8,yo),n("audio",{ref_key:"audioEndRef",ref:d,src:a(I)[a(E).audioEnd]},null,8,bo)])]))}});const Eo=G(ko,[["__scopeId","data-v-a3c3b100"]]),Do={id:"protect-horse-index"},Bo={class:"title"},Fo=["src"],Co={key:0},Io=M({__name:"index",setup(t){const o=R(),e=ke(),r=Ve(),h=x(()=>{let d="";switch(Y[o.mapLevel].type){case Q.Experience:{d="\u8BD5\u73A9";break}case Q.Endless:{d="\u534D";break}default:d=`\u7B2C${o.mapLevel}\u5173`}return`\u5854\u9632\u8054\u76DF (${d})`}),i=C({isProtectTheHorse:!0});function l(){Y[o.mapLevel].type===Q.Normal?P.info("\u767B\u5F55\u540E\u624D\u4F1A\u8BB0\u5F55\u5206\u6570"):P.info("\u5F53\u524D\u5173\u5361\u4E0D\u8BB0\u5F55\u5206\u6570")}function c(){o.loadingAllImg(),l()}function m(d){o.mapLevel!==d&&(o.mapLevel=d,r.push(`/game/${d+1}`),_(),l())}function _(){i.isProtectTheHorse=!1,re(()=>{i.isProtectTheHorse=!0})}return me(()=>{var d;if(o.mapLevel=+((d=e.params.id)!=null?d:1)-1,!Y[o.mapLevel]){i.isProtectTheHorse=!1;return}c()}),(d,w)=>(y(),b("div",Do,[D(a(Xe),{title:"\u60A8\u786E\u5B9A\u8981\u56DE\u5230\u9996\u9875\u5417\uFF0C\u5F53\u524D\u9875\u9762\u6E38\u620F\u6570\u636E\u5C06\u6E05\u9664",onConfirm:w[0]||(w[0]=s=>d.$router.push("/"))},{reference:A(()=>[n("div",Bo,[n("img",{src:a(Ze),alt:"",class:"title-icon"},null,8,Fo),a(o).isMobile?(y(),b("br",Co)):F("",!0),n("span",null,k(h.value),1)])]),_:1}),i.isProtectTheHorse?(y(),le(Eo,{key:0,onReStart:_,onExitGame:w[1]||(w[1]=s=>d.$router.push("/"))})):F("",!0),D(tt,{itemsNum:4,onSwitchMapLevel:m,onReStart:_})]))}});export{Io as default};
